KEYWORDS=google.load("visualization","1",{packages:["corechart"]});google.load("visualization","1",{packages:["table"]});
var app={map:null,layer:{heatmap:null,markerLead:L.marker([0,0]),markerDealer:{drew:L.marker([32.774917,-117.005639],{icon:L.icon({iconUrl:"images/logo_ford.png",iconSize:[60,35]})}),penske:L.marker([32.774917,-117.005639],{icon:L.icon({iconUrl:"images/logo_penske.png",iconSize:[60,35]})})}},dealer:"drew",controls:null,hitMapData:{max:1,data:[]},gridster:null,widgets:"widget_reputation widget_visibility widget_competitor widget_map widget_news widget_chart widget_tweetStream".split(" "),constants:{KEYWORDS:["car",
"buy","shopping","Ford"]},eventHandler:{click:"ontouchend"in document.documentElement?"touchend":"click",mouseover:"mouseover"}};$(function(){init_UI();init_news_widget()});function init_news_widget(){sortArray(rssFeeds,"score");showNews()}
function showNews(){var b="<ul>";$.each(rssFeeds,function(a,c){b+="<li rssIndex="+a+" title='Please click to see the news'><div class='score' title='Relevant Score. Powered by PathGeo'>"+c.score+"</div><div class='content'><label class='title'>"+c.name+" @ "+c.date+"</label><br>"+c.title+"</div></li>"});b+="</ul>";$("#rss_news").html(b);$("#rss_news ul li").click(function(){var a=$(this).attr("rssIndex");a&&""!=a&&($("#dialog_news_score").html(rssFeeds[a].score),$("#dialog_news_content").html("<label class='title'>"+
rssFeeds[a].title+"</label><br>"+rssFeeds[a].name+" @ "+rssFeeds[a].date),$("#dialog_news_goto").click(function(){window.open(rssFeeds[a].url)}),$("#dialog_news iframe").attr("src",rssFeeds[a].url),showDialog("dialog_news","news",{modal:!0,resizable:!1,draggable:!1,width:900,height:650,close:function(){$("#dialog_news iframe").html("").attr("src","")}}))})}function init_leads(){$("#leads").tabs({create:function(){init_leads_table(leads)}})}
function init_leads_table(b){var a="";$.each(b,function(b,d){"service"==b&&(a="service_leads");"sales"==b&&(a="sales_leads");$("#"+a).css({width:$("#"+a).parent().width()-40,height:$("#"+a).parent().height()-65});sortArray(d,"score");var f="<ul>";$.each(d,function(d,e){e.leadID=d;e.leadType=b;e.divName=a;f+="<li id="+d+" leadType='"+b+"'><div class='score'>"+e.score+"</div><div class='content'><img title='see more about the lead' src='"+userData[e.user].image_url+"' /><div><label class='title'>"+
e.user+"</label> says:<br>"+pathgeo.util.highlightKeyword(app.constants.KEYWORDS,e.text,!0)+"</div></div></li>"});$("#"+a).html(f)});$(".leads ul li .content img").bind(app.eventHandler.click,function(){var a=$(this).parent().parent().attr("id"),d=$(this).parent().parent().attr("leadType");showUserInfoDialog(b[d][a])});$(".leads ul li").bind(app.eventHandler.mouseover,function(){$(".leads ul li").css({"background-color":""});var a=$(this).attr("id"),d=$(this).attr("leadType");showLocation(b[d][a])})}
function showUserInfoDialog(b){var a=userData[b.user];$.extend(a,b);$("#user_image").attr("src",a.image_url);$(".userInfo").each(function(){$(this).attr("id")&&($(this).attr("id")&&a[$(this).attr("id")]&&""!=a[$(this).attr("id")])&&($(this).attr("textFormat")&&""!=$(this).attr("textFormat")&&1<$(this).attr("textFormat").split("{value}").length?$(this).html($(this).attr("textFormat").replace(RegExp("{value}","ig"),a[$(this).attr("id")])):($(this).html(a[$(this).attr("id")]),"text"==$(this).attr("id")&&
$(this).html(pathgeo.util.highlightKeyword(app.constants.KEYWORDS,a[$(this).attr("id")],!0))))});showDialog("dialog_user_info",b.user,{modal:!0})}
function showLocation(b){app.map.removeLayer(app.layer.markerLead);var a=Number(b.leadID);if(b.latlon&&2==b.latlon.length&&""!=b.latlon[0]&&""!=b.latlon[1]){app.layer.markerLead=L.marker(b.latlon);app.map.panTo(app.layer.markerLead.getLatLng());var c="<div class='popup' style=''><b>"+b.user+"</b> says: <br>"+b.text+"&nbsp; &nbsp; &nbsp; <a style='cursor:pointer'>more...</a></div>";L.popup().setLatLng(app.layer.markerLead.getLatLng()).setContent(c).openOn(app.map);$(".popup a").bind(app.eventHandler.click,
function(){showUserInfoDialog(b)});app.layer.markerLead.on("mouseover",function(){app.layer.markerLead.openPopup();$("#"+b.divName+" ul li:nth-child("+(a+1)+")").css({"background-color":"#eeeeee"})}).on("mouseout",function(){})}}function linkClick(b,a,c,d,f){$("."+b).each(function(){$(this).css({height:"20%"})});$("."+a).each(function(){$(this).css({display:"none"})});$("#"+c).parent().css({height:d});$("#"+f).css({display:""})}function changeHeight(b,a){$("#"+b).parent().css({height:a})}
function closeDiv(b){$("."+b).each(function(){$(this).css({height:"20%"})})}function closeTxt(b){$("."+b).each(function(){$(this).css({display:"none"})})}function changeColor(b,a){$("#"+b).css({"background-color":a})}function showText(b){$("#"+b).css({display:"inline"})}
function userContent(b){$("#"+b).html("<div class='content'>\n<img src='http://a0.twimg.com/profile_images/3268835550/1abe40bdc857158d00e165a7a0c21c8b_bigger.jpeg' style='float:left; padding-right:15px'/>\n<div style='font-size:15px; padding-left:15%' ><b>nathanW</b><br> San Diego, CA <br> 128 Friends <br> 972 Follows </div>\n</div>")}
function init_UI(){$(".gridster").append("<ul></ul>");app.gridster=$(".gridster > ul").gridster({widget_margins:[15,15],widget_base_dimensions:[$(".gridster").width()/7.45,$(".gridster").width()/7.45],draggable:{handle:".widget-title"}}).data("gridster");$.each(app.widgets,function(a,b){addWidget(b)});$(".widget-title").hover(function(){$(this).css("cursor","move")},function(){$(this).css("cursor","auto")});$("a#link").click(function(){var a=$("div#submenu");a.is(":visible")?a.fadeOut():a.fadeIn()});
var b=!1;$("div#submenu").mouseenter(function(){b=!0});$("div#submenu").mouseleave(function(){b=!1;setTimeout(function(){!1===b&&$("div#submenu").fadeOut()},400)})}
function init_map(){var b={OpenStreetMap:L.tileLayer("http://{s}.tile.cloudmade.com/ad132e106cd246ec961bbdfbe0228fe8/997/256/{z}/{x}/{y}.png",{styleId:256,attribution:""}),"Gray Map":L.tileLayer("http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/{styleId}/256/{z}/{x}/{y}.png",{styleId:22677,attribution:""}),"Night View":L.tileLayer("http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/{styleId}/256/{z}/{x}/{y}.png",{styleId:999,attribution:""})};app.map=L.map("map",{center:[32.834917,
-117.005639],zoom:9,layers:[b["Gray Map"]],attributionControl:!1});app.layer.cluster=pathgeo.layer.markerCluster(leadsToGeojson(leads.service.concat(leads.sales),"latlon"),{onEachFeature:function(a,b){var d="<div class='popup'><ul><li><label class='score'>"+a.properties.score+"</label><b>"+a.properties.user+":</b>&nbsp; "+a.properties.text+"</li></ul></div>",d=d.replace(/undefined/g,"Tweet"),d=pathgeo.util.highlightKeyword(app.constants.KEYWORDS,d,!0);b.bindPopup(d,{maxWidth:400,maxHeight:225})}},
{clusterclick:function(a){if(a.layer._popup)a.layer.openPopup();else{var b=pathgeo.util.readClusterFeatureProperies(a.layer,[]),d="<div class='popup'><b>"+a.layer._childCount+"</b> leads in this area:<p></p><ul>";$.each(b,function(a,b){d+="<li id="+b.leadID+" leadType='"+b.leadType+"' ><label class='score'>"+b.score+"</label><b>"+b.user+":</b>&nbsp; "+b.text+"</li>"});d+="</ul></div>";d=d.replace(/undefined/g,"Tweet");d=pathgeo.util.highlightKeyword(app.constants.KEYWORDS,d,!0);a.layer.bindPopup(d,
{maxWidth:400,maxHeight:225}).openPopup()}$(".popup ul li").bind(app.eventHandler.click,function(){var a=leads[$(this).attr("leadType")][$(this).attr("id")];showUserInfoDialog(a)}).bind(app.eventHandler.mouseover,function(){var a=leads[$(this).attr("leadType")][$(this).attr("id")];$("#"+a.divName+" ul li:nth-child("+(Number(a.leadID)+1)+")").css("background-color:#eeeeee;")})}}).addTo(app.map);app.controls=L.layerGroup().addTo(app.map);L.control.layers(b,{tweets:app.controls,cluster:app.layer.cluster,
lead:app.layer.markerLead});b=new L.Control.BingGeocoder("AvZ8vsxrtgnSqfEJF1hU40bASGwxahJJ3_X3dtkd8BSNljatfzfJUvhjo9IGP_P7");app.map.addControl(b);app.layer.markerDealer[app.dealer].addTo(app.map)}
function leadsToGeojson(b,a){if(!b&&!a)console.log("[ERROR] leadsToGeojson: no leadArray, location field name");else{var c={type:"FeatureCollection",features:[]};$.each(b,function(b,f){var g={type:"Feature",properties:f,geometry:{type:"Point",coordinates:[]}};$.each(f,function(b,c){b==a&&(g.geometry.coordinates=[c[1],c[0]])});c.features.push(g)});return c}}
function addWidget(b){var a=$("div[id="+b+"]");b=a.attr("widget-sizeX")||1;var c=a.attr("widget-sizeY")||1,d=a.attr("widget-row")||1,f=a.attr("widget-col")||1,g=app.gridster.add_widget("<li>"+createWidgetTitle(a)+a.html()+"</li>",b,c,f,d);g.attr("id",a.attr("id"));var e=app.gridster.min_widget_width*b-2*app.gridster.options.widget_margins[0]-1,h=setInterval(function(){g.width()>e&&(clearInterval(h),a.attr("widget-onInit")&&""!=a.attr("widget-onInit")&&eval(a.attr("widget-onInit")))},100);a.attr("widget-onClick")&&
""!=a.attr("widget-onClick")&&("widget_addWidget"!=g.attr("id")?g.find(".widget-detail").show().bind(app.eventHandler.click,function(){eval(a.attr("widget-onClick"))}):g.find("div:nth-child(2)").bind(app.eventHandler.click,function(){eval(a.attr("widget-onClick"))}));g.find(".widget-close").bind(app.eventHandler.click,function(){"widget_addWidget"!=g.attr("id")&&showDialog("div_closeWidget","Close Widget",{width:300,height:150,resizable:!1,draggable:!1,modal:!0,buttons:{Confirm:function(){a.attr("widget-onClose")&&
""!=a.attr("widget-onClose")&&eval(a.attr("widget-onClose"));app.gridster.remove_widget(g);$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}})});$("*").dialog("close")}
function createWidgetTitle(b){var a="<div class='widget-title'>";b.attr("widget-title")&&""!=b.attr("widget-title")&&(a+="<label>"+b.attr("widget-title")+"</label>");"widget_addWidget"!=b.attr("id")&&(a+="<span class='ui-icon ui-icon-close widget-close' title='close the widget'></span><span class='ui-icon ui-icon-search widget-detail' title='See more detail'></span></div>");return a}
function showDialog(b,a,c){c||(c={});c.title=c.title||a;c.width=c.width||700;c.height=c.height||500;c.resizable=c.resizable;c.dialogClass="dialog";c.closeFn=c.close||null;c.close=function(){c.closeFn&&c.closeFn();$("body").css("overflow","auto")};c.position=c.position||"center";$("body").css("overflow","hidden");$("#"+b).dialog(c)}
function sortArray(b,a){!b||0==b.length||!a||""==a?console.log("[ERROR]sortArray: no array or objName"):b.sort(function(b,d){switch($.type(b[a])){case "number":return b[a]==d[a]?0:b[a]<d[a]?1:-1;case "string":return"date"==a?new Date(b[a])<new Date(d[a])?1:-1:b[a]>d[a]?1:-1}})}
function init_tweetStream(){(new TWTR.Widget({version:2,id:"tweet",subject:'Now Streaming: "Nascar"',type:"search",search:"nascar",interval:30,width:"auto",height:$("li[id=widget_tweetStream]").height()-$(".widget_title").height()-105,theme:{shell:{background:"#8ec1da",color:"#ffffff"},tweets:{background:"#ffffff",color:"#444444",links:"#1985b5"}},features:{scrollbar:!0,loop:!0,live:!0,behavior:"all"}})).render().start()}
function init_reputation_graph(){showDialog("dialog_reputation","Reputation",{modal:!0});$(".changeRepGraph").css("cursor","pointer");var b=getScore("weeklyRep"),a=google.visualization.arrayToDataTable(b),c={legend:{position:"none"},vAxis:{minValue:-100,maxValue:100,gridlines:{count:5}},hAxis:{showTextEvery:4},pointSize:4},d=new google.visualization.LineChart(document.getElementById("graph_rep"));d.draw(a,c);$(".changeRepGraph").click(function(){b=getScore($(this).attr("id"));a=google.visualization.arrayToDataTable(b);
if("dailyRep"==$(this).attr("id"))var e=2;"weeklyRep"==$(this).attr("id")&&(e=4);"monthlyRep"==$(this).attr("id")&&(e=8);c={legend:{position:"none"},vAxis:{minValue:-100,maxValue:100,gridlines:{count:5}},hAxis:{showTextEvery:e},pointSize:4};d.draw(a,c);$(".changeRepGraph").css("font-weight","normal");e="#"+$(this).attr("id");$(e).css("font-weight","bold")});var f=new google.visualization.DataTable;f.addColumn("string","Rating");f.addColumn("string","Date");f.addColumn("string","Review");for(var g in reviews){var e=
reviews[g];e.Rating="+"==e.Rating.charAt(0)?"<span style='color:green; font-weight:bold'>"+e.Rating+"</span>":"<span style='color:red; font-weight:bold'>"+e.Rating+"</span>";review="<div style='float:left'><img src='images/small/"+e.Source+".png' alt='logo' ></div>"+e.Review;f.addRow([e.Rating,e.Date,review])}(new google.visualization.Table(document.getElementById("review_rep"))).draw(f,{showRowNumber:!1,allowHtml:!0,sortColumn:1,sortAscending:!1})}
function init_visibilty_graph(){showDialog("dialog_visibility","Visibility",{modal:!0});$(".changeVisGraph").css("cursor","pointer");var b=getScore("weeklyVis"),a=google.visualization.arrayToDataTable(b),c={legend:{position:"none"},vAxis:{minValue:-100,maxValue:100,gridlines:{count:5}},hAxis:{showTextEvery:4},pointSize:4},d=new google.visualization.LineChart(document.getElementById("graph_vis"));d.draw(a,c);$(".changeVisGraph").click(function(){b=getScore($(this).attr("id"));a=google.visualization.arrayToDataTable(b);
if("dailyVis"==$(this).attr("id"))var e=2;"weeklyVis"==$(this).attr("id")&&(e=4);"monthlyVis"==$(this).attr("id")&&(e=8);c={legend:{position:"none"},vAxis:{minValue:-100,maxValue:100,gridlines:{count:5}},hAxis:{showTextEvery:e},pointSize:4};d.draw(a,c);$(".changeVisGraph").css("font-weight","normal");e="#"+$(this).attr("id");$(e).css("font-weight","bold")});var f=new google.visualization.DataTable;f.addColumn("string","Rating");f.addColumn("string","Date");f.addColumn("string","Chatter");for(var g in reviews){var e=
reviews[g];e.Rating="+"==e.Rating.charAt(0)?"<span style='color:green; font-weight:bold'>"+e.Rating+"</span>":"<span style='color:red; font-weight:bold'>"+e.Rating+"</span>";f.addRow([e.Rating,e.Date,"<div style='float:left'><img src='images/small/"+e.Source+".png' alt='logo' ></div>"+e.Review])}(new google.visualization.Table(document.getElementById("review_vis"))).draw(f,{showRowNumber:!1,allowHtml:!0,sortColumn:1,sortAscending:!1})}
function switch_user(b){"penske"==b?($("#link").html("General Manager<span class='ui-icon ui-icon-carat-1-s widget-dropdown' title='Expand'></span>"),$("#logo").html("<img src = 'images/logo_penske.png' alt='logo' border='0' style = 'float:left;padding-right:15px' />")):($("#link").html("General Manager<span class='ui-icon ui-icon-carat-1-s widget-dropdown' title='Expand'></span>"),$("#logo").html("<img src = 'images/logo_ford.png' alt='logo' border='0' style = 'float:left;padding-right:15px' />"));
$("div#submenu").hide();$.each(app.layer.markerDealer,function(a,b){app.map.removeLayer(b)});app.layer.markerDealer[b].addTo(app.map);app.dealer=b}function logout(){$("#link").html("Sign In<span class='ui-icon ui-icon-carat-1-s widget-dropdown' title='Expand'></span>");$("#logo").html("");$("div#submenu").hide()}
function changeChart(b){var a=getData(b);if("line"==b){var c={title:"Total Mentions per Day",legend:{position:"none"},hAxis:{showTextEvery:2},pointSize:4,titleTextStyle:{color:"#555555",fontName:"Arial",fontSize:12}},d=google.visualization.arrayToDataTable(a),f=new google.visualization.LineChart(document.getElementById("chart"));f.draw(d,c)}"pie"==b&&(c={title:"Total Mentions, Feb 22-28",titleTextStyle:{color:"#555555",fontName:"Arial",fontSize:12}},d=google.visualization.arrayToDataTable(a),f=new google.visualization.PieChart(document.getElementById("chart")),
f.draw(d,c))};